[gcode_macro SORKIN_METHOD_BED_CALIBRATE]
description: Moving down the table after standard BED_MESH_CALIBRATE to the specified distance to provide more space for applying tape using Dmitry Sorkin method
gcode:
    {% set sorkin_bed = params.DISTANCE|default(0)|int %}

    RESPOND PREFIX="info" MSG="instructions https://www.youtube.com/watch?v=9j_rT0ATjXo&t=3s"
    SET_GCODE_VARIABLE MACRO=_FIX_BED_MESH_CALIBRATE VARIABLE=dis_for_down_table VALUE={sorkin_bed}

[gcode_macro _FIX_BED_MESH_CALIBRATE]
variable_dis_for_down_table: 0
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set profile = params.PROFILE|default("default") %}
    {% set z_min = printer.configfile.settings.stepper_z.position_min %}
    {% set z_max = printer.configfile.settings.stepper_z.position_max %}

    RESPOND PREFIX="info" MSG="Before measurements, don't forget to clean the nozzle with CLEAR_NOZZLE macro"
    _G28
    _GOTO_MID
    LOAD_CELL_TARE

    {% if dis_for_down_table > 0 and dis_for_down_table <= z_max %}
        RESPOND PREFIX="info" MSG="Using BED_MESH_CALIBRATE and then down the table to {dis_for_down_table}mm for more space for sticking the tape."
        _BED_MESH_CALIBRATE PROFILE="{profile}"
        G0 Z{dis_for_down_table} F900
        G0 X{client.custom_park_x} Y{client.custom_park_y} F3000 
    {% elif dis_for_down_table == 0 %}
        RESPOND PREFIX="info" MSG="Using BED_MESH_CALIBRATE. macro _FIX_BED_MESH_CALIBRATE."
        RESPOND PREFIX="info" MSG="SORKIN_METHOD_BED_CALIBRATE disabled"
        _BED_MESH_CALIBRATE PROFILE="{profile}"
    {% elif dis_for_down_table < 0 or dis_for_down_table < z_min %}
        RESPOND PREFIX="!!" MSG="parameter SORKIN_METHOD_BED_CALIBRATE move out range z_min:{dis_for_down_table}"
    {% elif dis_for_down_table > z_max %}
        RESPOND PREFIX="!!" MSG="parameter SORKIN_METHOD_BED_CALIBRATE move out range z_max:{dis_for_down_table}"
    {% endif %}
